## 视频通话功能

#### 1. 前端实现

```javascript
import { ref } from 'vue'

const localVideo = ref(null)

let ws = new WebSocket('ws:192.168.3.38:9900')

ws.onopen = () => {
    // 建立连接 发送用户信息
    ws.send(
        JSON.stringify({
            type: 'register',
            id: 'wzh111',
            username: '小文111'
        })
    )
}

ws.onmessage = async msg => {
    const message = JSON.parse(msg.data)

    if (message.type === 'candidate') {
        // 两个设备之间 建立连接
        await localPeer.addIceCandidate(new RTCIceCandidate(message.candidate))
    }

    if (message.type === 'offer') {
        await localPeer.setRemoteDescription(new RTCSessionDescription(message.sdp))

        const answer = await localPeer.createAnswer()
        await localPeer.setLocalDescription(answer)

        ws.send(
            JSON.stringify({
                type: 'answer',
                sdp: localPeer.localDescription,
                from: '小文111', // 当前 id, 根据业务需要动态添加
                to: '小文222' // 需要连接的 id
            })
        )
    }

    if (message.type === 'answer') {
        await localPeer.setRemoteDescription(new RTCSessionDescription(message.sdp))
    }
}

ws.onerror = err => {
    console.log(err)
}

ws.onclose = () => {
    // 关闭
    console.log('closed')
}

// RTCPeerConnection(音频类数据)     RTCDataChannel(建立数据通道)
const localPeer = new RTCPeerConnection() // 本地

// 设备信息
localPeer.addEventListener('icecandidate', async event => {
    if (event.candidate) {
        ws.send(
            JSON.stringify({
                type: 'candidate',
                candidate: event.candidate,
                from: '小文111',
                to: '小文222'
            })
        )
    }
})

// 显示 流 数据
localPeer.ontrack = event => {
    if (localVideo.value?.srcObject !== event.streams[0]) {
        localVideo.value.srcObject = event.streams[0]
        localVideo.value.controls = true
    }
}

// 点击建立连接后执行
const openCamera = async () => {
    try {
        const LocalStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        })

        // 添加本地视频流到会话中  会触发 icecandidate 事件
        LocalStream.getTracks().forEach(track => {
            localPeer.addTrack(track, LocalStream)
        })

        // 本地预览
        // localVideo.value.srcObject = LocalStream

        const offer = await localPeer.createOffer()

        // offer localPeer.localDescription
        await localPeer.setLocalDescription(offer)

        ws.send(
            JSON.stringify({
                type: 'offer',
                sdp: localPeer.localDescription,
                from: '小文111',
                to: '小文222'
            })
        )
    } catch (err) {
        console.log('getUserMedia error:' + err)
    } finally {
        // console.log('之后执行')
    }
}
```

#### 2. 信令服务器 后端实现

```javascript
const WebSocket = require('ws')

// port: 9900   监听的端口号
const wss = new WebSocket.Server({ port: 9900 })

const peers = {}

wss.on('connection', ws => {
    // ws.on('message', data => {
    //     // 群发 ws.send(data)
    //     wss.clients.forEach(client => {
    //         if (client.readyState === WebSocket.OPEN) {
    //             client.send(data.toString('utf8'))
    //         }
    //     })
    // })

    ws.on('message', message => {
        const data = JSON.parse(message)

        let peer = null

        switch (data.type) {
            case 'register':
                peers[data.username] = ws
                break
            case 'offer':
                peer = peers[data.to]

                if (peer) {
                    peer.send(JSON.stringify({ type: 'offer', from: data.from, sdp: data.sdp }))
                }
                break
            case 'answer':
                peer = peers[data.to]
                if (peer) {
                    peer.send(JSON.stringify({ type: 'answer', from: data.from, sdp: data.sdp }))
                }
                break

            case 'candidate':
                peer = peers[data.to]
                if (peer) {
                    peer.send(JSON.stringify({ type: 'candidate', from: data.from, candidate: data.candidate }))
                }
                break
            default:
                peer = null
        }
    })

    ws.on('close', () => {
        for (const [username, peer] of Object.entries(peers)) {
            if (peer === ws) {
                console.log(username)
                delete peers[username]
                break
            }
        }
    })
})
```
